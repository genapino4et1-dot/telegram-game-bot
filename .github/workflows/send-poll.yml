name: ü§ñ –û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 08:00 UTC = 11:00 –ú–°–ö
    - cron: '0 8 * * *'
  
  # –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  send-poll:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø—Ä–æ—Å–∞ –≤ Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          TOPIC_ID: ${{ secrets.TOPIC_ID }}
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."
          
          # –î–∞—Ç–∞ –¥–ª—è –ú–æ—Å–∫–≤—ã
          MOSCOW_DATE=$(TZ=Europe/Moscow date '+%d.%m.%Y')
          
          # –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–æ-—Ä—É—Å—Å–∫–∏
          WEEKDAY=$(TZ=Europe/Moscow date '+%u')
          case $WEEKDAY in
            1) DAY="–ü–ù";;  2) DAY="–í–¢";;  3) DAY="–°–†";;
            4) DAY="–ß–¢";;  5) DAY="–ü–¢";;  6) DAY="–°–ë";;
            7) DAY="–í–°";;
          esac
          
          # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
          MESSAGE="üéÆ <b>–ò–ì–†–ê–ï–ú –°–ï–ì–û–î–ù–Ø?</b>

üìÖ $MOSCOW_DATE ($DAY)
‚è∞ 11:00 –ú–°–ö

<i>–û—Ç–≤–µ—Ç—å—Ç–µ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ ‚Üì</i>"
          
          # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
          KEYBOARD='{
            "inline_keyboard": [[
              {"text": "‚úÖ –î–ê", "callback_data": "yes"},
              {"text": "‚ùå –ù–ï–¢", "callback_data": "no"}
            ]]
          }'
          
          echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ Telegram..."
          
          # –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –° –¢–ï–ú–û–ô
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"$CHAT_ID\",
              \"message_thread_id\": $TOPIC_ID,
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"HTML\",
              \"reply_markup\": $KEYBOARD
            }" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage")
          
          echo "–û—Ç–≤–µ—Ç: $RESPONSE"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—Ö
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–º—É $TOPIC_ID"
          else
            echo "‚ö†Ô∏è –ü—Ä–æ–±—É–µ–º –±–µ–∑ —Ç–µ–º—ã..."
            
            # –ü—Ä–æ–±—É–µ–º –ë–ï–ó –¢–ï–ú–´
            curl -s -X POST \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"$CHAT_ID\",
                \"text\": \"$MESSAGE\",
                \"parse_mode\": \"HTML\",
                \"reply_markup\": $KEYBOARD
              }" \
              "https://api.telegram.org/bot$BOT_TOKEN/sendMessage"
            
            echo "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–µ–∑ —Ç–µ–º—ã"
          fi
